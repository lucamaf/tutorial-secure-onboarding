<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RHEL OSTree image - Lab :: Secure Edge device onboarding with RHEL and FDO</title>
    <link rel="canonical" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/fdo-tutorial/02-rfe-lab.html">
    <link rel="prev" href="02-rfe-intro.html">
    <link rel="next" href="03-onboarding.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/device-edge" target="_blank"><img
          src="../_/img/header_logo.png" height="60px" alt="Red Hat Device Edge"></a>
      <a color="white" href="https://luisarizmendi.github.io/tutorial-secure-onboarding">Secure Edge device onboarding with RHEL and FDO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Repos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/luisarizmendi/rhel-edge-quickstart" target="_blank">RHEL OSTree quickstart scripts</a>
          </div>
        </div>
       
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Articles</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://medium.com/@luis-javier-arizmendi-alonso/edge-computing-device-onboarding-part-i-introducing-the-challenge-59add9a86200" target="_blank">FDO series</a>
            <a class="navbar-item" href="https://medium.com/@luis-javier-arizmendi-alonso/a-git-like-linux-operating-system-d84211e97933" target="_blank">RHEL OSTree</a>


          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Slides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://docs.google.com/presentation/d/1FKQDHrleCPuE0e36UekzXdkw86wNDx16dSgllXj-swY/edit?usp=sharing" target="_blank">Red Hat Device Edge (internal)</a>

          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/rhs-openshift-starter-guides/4.9/index.html" target="_blank">OpenShift</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/acs-workshop/acs-workshop/index.html" target="_blank">ACM</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="fdo-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Secure Edge device onboarding with RHEL and FDO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-prerequisites.html">Lab prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#virtualization">Prepare your virtualization environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#arch">Choose your lab architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#usecase">Create your use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-intro.html">Introduction to secure edge device onboarding</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-scaling">Scaling traditional device deployment for the edge environments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-security">Device onboarding security and image templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-fdo">Centralizing the device onboarding intelligence</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html">1.a FDO - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-origins">FDO&#8217;s origins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-components">FDO components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow">FDO workflow</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-before">1. Before the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-during">2. During the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-after">3. After the first boot</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html">1.b FDO - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-services">FDO services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-services-aio">Option 1: All-in-one FDO server installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-services-dedicated">Option 2: Dedicated FDO servers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-config">FDO Service API config</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona">Option A: Creating your own use case</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-user">initial_user</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-files">files</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-commands">commands</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-encrypt">diskencryption_clevis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optionb">Option B: Using the example use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-lab.html#fdo-summary">FDO Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-intro.html">2.a RHEL OSTree images - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-benefits">OSTree RHEL benefits for edge computing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-article">OSTree-based Operating Systems article</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-lab.html">2.b RHEL OSTree image - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#rfe-imagebuilder">Install Image builder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#rfe-image">Create the RHEL OSTree image</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#rfe-ostreeimage">Generating the repo image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#rfe-ostreeimage-optiona">Option A: Blueprint file for your own FDO onboarding automation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#rfe-ostreeimage-optionb">Option B: Blueprint file for the provided FDO automation example</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#rfe-ostreeimage-createrepo">Creating the OSTree repository</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#rfe-publish">Publishing the repo image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#rfe-iso">Create the RHEL ISO</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#rfe-summary">RHEL OSTree image Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-onboarding.html">3. Edge device onboarding - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-vm">Step 0 - Create the edge device VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-first">Step 1 - Edge device&#8217;s first boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-voucher">Step 2 - Distribute the Vouchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-finalboot">Step 3 - Automatic onboarding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-checks">Checking the edge device onboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-change">Updating the onboard automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-summary">Edge device onboarding Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Secure Edge device onboarding with RHEL and FDO</a></li>
    <li><a href="02-rfe-lab.html">2.b RHEL OSTree image - Lab</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/luisarizmendi/tutorial-secure-onboarding/edit/master/documentation/modules/ROOT/pages/02-rfe-lab.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">RHEL OSTree image - Lab</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you are going to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the Image Builder service in RHEL</p>
</li>
<li>
<p>Create a OSTree RHEL image by:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Creating a blueprint file to customize the setup</p>
</li>
<li>
<p>Create a new OSTree repo</p>
</li>
<li>
<p>Publish the OStree repo</p>
</li>
<li>
<p>Create an ISO where you inject that OSTree repository</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As explained in the <a href="02-rfe-intro.html" class="xref page">RHEL for Edge introduction</a>, in order to use an OSTree RHEL you need to create an image. You have two options while creating these images, you can use the <a href="https://console.redhat.com/edge/manage-images">Red Hat Hybrid Console</a> on the cloud or install and use Image Builder in an RHEL system.</p>
</div>
<div class="paragraph">
<p>In this lab we are going to use the second option, since at this moment the FDO integration is not yet ready in the Red Hat Hybrid Console.</p>
</div>
<div class="paragraph">
<p>Once Image builder is installed, you will need to create an RHEL "edge" image. In this lab we will perform the steps manually, so you understand better the procedure, but Red Hat is developing an <a href="https://github.com/redhat-cop/infra.osbuild">Ansible collection</a> to automate the RHEL for Edge image creation and life-cycle management.</p>
</div>
<div class="paragraph">
<p>The image that you are going to create should include all RPMs needed by your onboarding automation. Since you had two options while creating the onboarding automation with FDO (using your own use case or the provided example) in this section you will also have to follow the same approach.</p>
</div>
<div class="paragraph">
<p>If you prepared your own automation, you will need to be sure about the Software dependencies that your automation has, for example, in the example onboarding automation, the system will use the insights client which is not included by default in the RHEL for Edge OSTree image, so we need to specify that the image that we are going to create needs to include such RPM too (we will see that&#8217;s done with the <code>blueprint</code> file).</p>
</div>
<div class="paragraph">
<p>But first, let&#8217;s start from the beginning and let&#8217;s install the Image Builder.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rfe-imagebuilder"><a class="anchor" href="#rfe-imagebuilder"></a>Install Image builder</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step is to install the Image Builder in one of the RHEL VMs that you prepared.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y osbuild-composer composer-cli  bash-completion</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to enable the service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl enable osbuild-composer.socket --now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Load the shell configuration script so that the autocomplete feature for the composer-cli command starts working immediately without reboot:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">source /etc/bash_completion.d/composer-cli</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will be using the CLI to create and manage the RHEL images, but you can also use <a href="https://www.redhat.com/sysadmin/intro-cockpit">Cockpit</a>. You can install and enable it by running these commands (including opening the TCP ports if you have a Firewall installed in your system)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y cockpit-composer

sudo systemctl enable cockpit.socket --now

sudo firewall-cmd --add-service=cockpit &amp;&amp; sudo firewall-cmd --add-service=cockpit --permanent
sudo firewall-cmd --reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to take a look at Cockpit just go to <code><a href="http://&lt;image-builder" class="bare">http://&lt;image-builder</a> IP&gt;:9090</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rfe-image"><a class="anchor" href="#rfe-image"></a>Create the RHEL OSTree image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You are going to follow three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate a new OSTree RHEL repository</p>
</li>
<li>
<p>Download the repository and publish it on a Web server</p>
</li>
<li>
<p>Use Image Builder to create an ISO image using the repository published on the Web server</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s begin with the first step.</p>
</div>
<div class="sect2">
<h3 id="rfe-ostreeimage"><a class="anchor" href="#rfe-ostreeimage"></a>Generating the repo image</h3>
<div class="paragraph">
<p>You need first to create the blueprint file where you include the image customizations and then use that file to create the actual OSTree repository.</p>
</div>
<div class="paragraph">
<p>When it comes to create the blueprint file for this lab, you need to follow the same option that you selected during the FDO lab: are you going to <a href="#rfe-ostreeimage-optiona">use your own automation</a>, or you didn&#8217;t prepare anything and would like to <a href="#rfe-ostreeimage-optionb">use the proposed example</a>?.</p>
</div>
<div id="rfe-ostreeimage-optiona" class="paragraph">
<p><strong>Option A: Blueprint file for your own FDO onboarding automation</strong></p>
</div>
<div class="paragraph">
<p>You can customize the image created by the Image Builder through a <code>blueprint.toml</code> file. You can check <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/index">how to use blueprint in Image Builder</a> but take into account that not all variables are applied to create OSTree images, so it&#8217;s better to review the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#image-customizations_composing-a-rhel-for-edge-image-using-image-builder-command-line">supported blueprint configurations for RHEL for Edge</a> documentation.</p>
</div>
<div class="paragraph">
<p>You can find a blueprint example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">name = "factory-edge"
description = "Sample blueprint"
version = "0.0.1"
modules = [ ]
groups = [ ]

[[packages]]
name = "insights-client"
version = "*"

[[packages]]
name = "cockpit"
version = "*"

[customizations]
hostname = "edge-node"

[customizations.services]
enabled = ["cockpit","insights-client"]

[customizations.firewall]
ports = ["9090:tcp"]


[[customizations.sshkey]]
user = "root"
key = "ssh-rsa AAAA...."


[[customizations.user]]
name = "admin"
description = "Admin user"
password = '$6$kJ5K....CmUFIm4KduMkm9/'
key = "ssh-rsa AAAA...."
home = "/home/admin/"
shell = "/usr/bin/bash"
groups = ["users", "wheel"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the first section you need to specify the blueprint name and a description, along with the blueprint version.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">name = "factory-edge"
description = "Sample blueprint"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, you can include modules and group of packages into the image using the <code>modules = [ ]</code> and <code>groups = [ ]</code> sections, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[groups]]
name = "Desktop"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to include individual packages you can use the <code><a id="packages"></a></code> section.</p>
</div>
<div class="paragraph">
<p>Then you can  use this section multiple times to include additional single RPM packages that are not included by default in the RHEL OSTree images (ie. <code>insights-client</code>) indicating which version you would like to install (or any/latest with <code>*</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[packages]]
name = "tree"
version = "*"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bear in mind that in order to install those RPM packages in the image, the Image Builder needs to have access to them. There might be cases where the RPM is not present in the Image Builder repositories. In that case, you could configure additional repositories that can be used by the Image Builder servers.</p>
</div>
<div class="paragraph">
<p>You can find an example of including additional repositories in Image Builder in <a href="https://github.com/luisarizmendi/rhel-edge-quickstart/blob/master/scripts/add-microshift-repos.sh">this script that builds the Microshift RPMs and adds it as a local repository (along with an additional OpenShift repository) into the Image Builder</a>.</p>
</div>
<div class="paragraph">
<p>It could happen that one of the installed packages contains a Systemd service, and probably you would like to enable that service by default. You can use the <code>[customizations.services]</code> to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.services]
enabled = ["cockpit","insights-client"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also manage the firewalld configuration, for example, you can open ports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.firewall]
ports = ["8080:tcp"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or directly enabling services by name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.firewall.services]
enabled = ["SERVICES"]
disabled = ["SERVICES"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Regarding system users, by default, the image only has the root user configured but with no password, so in order to have access to the system (with root user) you will need to include a Public SSH key that will be injected into the image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.sshkey]]
user = "root"
key = "&lt;SSH PUB KEY&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>But what if you want one or multiple "initial users". You can add more "initial" users to the system by using the <code><a id="customizations.user"></a></code> section (you can include more than one), where you add the user name, password, public SSH key, shell to be used, and user groups.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.user]]
name = "admin"
description = "Admin user"
password = '$6$kJ5KDNibL76RnLzW$CQp6UL936Buu8RDtrCKtL0jpDDO.oTQjyzb.GkDL2b6wiOGoO8K/TWhTnggvJn4bMHt5yw3CmUFIm4KduMkm9/'
key = "ssh-rsa AAAA...."
home = "/home/admin/"
shell = "/usr/bin/bash"
groups = ["users", "wheel"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The password needs to be encrypted, you cannot express the user password in plain text in the blueprint file. You can obtain the encrypted password string by running this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember what was mentioned in the <a href="01-fdo-lab.html#fdo-optiona-user" class="xref page">initial_user section of the FDO Lab</a>, if you configured there a user name, be sure that you create it in the blueprint too with the same name, otherwise you will get this error while onboarding the device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">0: Error installing SSH key
1: User admin for SSH key installation missing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional comment about the users in OSTree RHEL. If you went through the <a href="02-rfe-intro.html#rfe-intro-article" class="xref page">OSTree-based Operating Systems article</a> shared in the previous module, you noticed that in OSTree RHEL you will have two "kinds" of users, the ones created on the first boot of the image, and the ones generated by day-2 operations. The users created by the Image Builder could be described as these "initial" users that are created during the first boot of the device, and whose target is to perform the onboarding configurations and as administrative access to the devices.</p>
</div>
<div class="paragraph">
<p>Besides these common sections, in the blueprints you can also configure other system parameters such as the timezone, NTP server or locale:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.timezone]
timezone = "TIMEZONE"
ntpservers = "NTP_SERVER"


[customizations.locale]
languages = ["LANGUAGE"]
keyboard = "KEYBOARD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, Image Builder builds a default kernel into the image. But, you can also customize the kernel, for example appending a kernel boot parameter option to the defaults:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.kernel]
append = "KERNEL-OPTION"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a Real-Time Kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.kernel]
name = "KERNEL-rt"</code></pre>
</div>
</div>
<div class="paragraph">
<p>or defining a kernel name to use in an image</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.kernel.name]
name = "KERNEL-NAME"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, you can specify a custom filesystem configuration in your blueprints and therefore create images with a specific disk layout, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.filesystem]]
mountpoint = "/opt"
size = "20 GiB"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The blueprint supports the following mountpoints and their sub-directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/
/var
/home
/opt
/srv
/usr
/app
/data
/boot</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want more than one partition, you can create images with a customized file system partition on LVM and resize those partitions at runtime.</p>
</div>
<div class="paragraph">
<p>After completing the Blueprint file preparation, move to the <a href="#rfe-ostreeimage-createrepo">creating the OSTree repository</a> section.</p>
</div>
<div id="rfe-ostreeimage-optionb" class="paragraph">
<p><strong>Option B: Blueprint file for the provided FDO automation example</strong></p>
</div>
<div class="paragraph">
<p>If you plan to use the provided example, you just need to download the Blueprint template and adapt it to your environment by changing certain values on it.</p>
</div>
<div class="paragraph">
<p>Start by downloading the blueprint:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -O <a href="https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/blueprint-insights.toml" class="bare">https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/blueprint-insights.toml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then setup some variables with your values, you public SSH key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SSH_PUB_KEY="ssh-rsa AAAAB3......am8= user@machine"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the password for the initial user (which is pre-configured to be <code>admin</code>):</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ADMIN_PASSW=$(python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to apply those variables into the Blueprint template:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -i "s|&lt;SSH PUB KEY&gt;|${SSH_PUB_KEY}|g" blueprint-insights.toml
sed -i "s|&lt;ADMIN PASSW&gt;|${ADMIN_PASSW}|g" blueprint-insights.toml</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>and you are done with the Blueprint.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="rfe-ostreeimage-createrepo"><a class="anchor" href="#rfe-ostreeimage-createrepo"></a>Creating the OSTree repository</h3>
<div class="paragraph">
<p>Once you have your Blueprint, you are ready to create the OSTree repository/image with Image Builder.</p>
</div>
<div class="paragraph">
<p>The first step is to "push" the Blueprint into Image Builder pointing to the file that you created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli blueprints push &lt;blueprint_file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if you used the provided blueprint file, the exact command would be:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli blueprints push blueprint-insights.toml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can double-check that the Blueprint is ready to be used in the Image Builder with this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli blueprints list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now is time to create the OSTree image. You will need to point to the name that you gave to the Blueprint (the one that you used in the <code>name</code> parameter in the Blueprint file), not the file name as you did in the previous step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli compose start-ostree &lt;blueprint_name&gt; edge-commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you used the provided Blueprint, which name is <code>kvm-insights</code>, the command will be:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli compose start-ostree kvm-insights edge-commit</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In this lab we are using the <code>edge-commit</code> image type. You could use the <code>edge-container</code> type as well as it&#8217;s explained in the <a href="#rfe-publish">publishing the repo image</a> section.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The command will start to create the repo. You can check the status of the build by running the following command (remember to use <code>CTL-C</code> to finish the <code>watch</code> process):</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_input"></a>input</p>
</li>
<li>
<p><a id="tabset1_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch sudo composer-cli compose status</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">2d1030cb-6900-4e0b-994b-248c5bb55f7c RUNNING  Wed Nov 30 10:11:30 2022 kvm-insights    0.0.1 edge-commit</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You will need to wait until the status for your image changes to 'FINISHED` (which it takes more or less 10 min in my VM with 2 cores and 4 GB memory), then the image will ready in Image Builder.</p>
</div>
</div>
<div class="sect2">
<h3 id="rfe-publish"><a class="anchor" href="#rfe-publish"></a>Publishing the repo image</h3>
<div class="paragraph">
<p>There are multiple ways of distributing the RHEL OSTree images. If you take a look at this <a href="https://github.com/luisarizmendi/rhel-edge-quickstart">RHEL for Edge quickstart GitHub repository</a> or at the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/introducing-rhel-for-edge-images_composing-installing-managing-rhel-for-edge-images">Red Hat official documentation</a> you will learn more about the network and non-network based deployments, but you will find that both have something in common, you need to have the OSTree image/repo "published" into a HTTP server.</p>
</div>
<div class="paragraph">
<p>When you created the image in the previous section, you used the <code>edge-commit</code> image type, which means that Image Builder create the OSTree image contents and put them into a <code>TAR</code> file. There is another image type that you might use here, the <code>edge-container</code> type, which creates the OSTree image contents and directly creates a container image that publishes them using <code>HTTPD</code>. In this lab we are going to use the first approach (although as you will see it requires some additional steps) because this procedure can be used for either network and non-network based deployments, since you can include additional information into the container image (ie. a <code>kickstart</code> file) and because you will be able to manage the lifecycle of this container image (ie. image patching) which is convenient for production environments.</p>
</div>
<div class="paragraph">
<p>Since we used the <code>edge-commit</code> image type, you have your OSTree image in Image Builder as a <code>TAR</code> file but in order to use it you will need to "download" it using the following command, where the <code>IMAGE ID</code> is the ID generated by the Image Builder and that you can find using the command <code>sudo composer-cli compose status</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli compose image &lt;IMAGE ID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will download a <code>TAR</code> file with all the OSTree image contents. If you are not using the <code>root</code> user, remember to change the file owner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo chown $(whoami) &lt;IMAGE TAR FILE&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are going to use a container image to publish the OSTree image (as the <code>edge-container</code> image type does) so you need to have <code>podman</code> installed in your system (probably you want to use the same VM where the Image Builder is installed):</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y podman</code></pre>
</div>
</div>
<div class="paragraph">
<p>The idea is to create a container image with NGINX, so you can customize even the NGINX configuration as part of this procedure. Create the NGINX config file:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; nginx.conf
events {
}
http {
    server{
        listen 8080;
        root /usr/share/nginx/html;
        location / {
            autoindex on;
            }
        }
     }
pid /run/nginx.pid;
daemon off;
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the Dockerfile including this configuration (and exposing the same port that you configured in your NGINX config file, 8080 in this example) file and the OSTree image TAR file. You could use a Dockerfile "argument" to point to the OSTree image file:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; Dockerfile
FROM registry.access.redhat.com/ubi8/ubi
RUN yum -y install nginx &amp;&amp; yum clean all
ARG commit
ADD \$commit /usr/share/nginx/html/
ADD nginx.conf /etc/
EXPOSE 8080
CMD ["/usr/sbin/nginx", "-c", "/etc/nginx.conf"]
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can create your container image using this Dockerfile. If you used an argument for the OSTree iamge you need to include the full path to your OSTree repo <code>TAR</code> file:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Do not forget the last <code>.</code></p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman build -t &lt;CONTAINER IMAGE NAME&gt; --build-arg commit=&lt;IMAGE TAR FILE&gt; .</code></pre>
</div>
</div>
<div class="paragraph">
<p>An idea for the container image could be a mix of the Blueprint name and the OSTree image ID, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;blueprint_name&gt;:&lt;image id&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sudo podman build -t kvm-insights:ebcfe8b5-5aed-4d9b-a948-d7ddb9b51150 --build-arg commit=ebcfe8b5-5aed-4d9b-a948-d7ddb9b51150-commit.tar .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also a good idea is to tag the last container image as "latest":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman tag &lt;blueprint_name&gt;:&lt;image id&gt; &lt;blueprint_name&gt;:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have the container image ready you can run a container based on it, but before that, be sure that you opened the required port. You will need to bind a port in your VM to the port configured in your container image (tcp/8080 in this example).</p>
</div>
<div class="paragraph">
<p>Remember that if you are using this VM to run other services, for example the FDO services, you need to be sure that you don&#8217;t use the same ports (use tcp/8090 to be sure that it does not interfiere with FDO default ports)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IMAGE_PUBLISH_PORT=8090</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the variable to open the port. If you are using Firewalld the command is:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo firewall-cmd --add-port=${IMAGE_PUBLISH_PORT}/tcp --permanent
sudo firewall-cmd --reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now is time to run the container. Probably you want to name this container with the same name than your container image, but remember that you cannot use special characters such as <code>:</code> for your container name, so you will need to change the <code>:</code> by <code>-</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman run --name &lt;blueprint_name&gt;-&lt;image id&gt; -d -p  ${IMAGE_PUBLISH_PORT}:8080 &lt;blueprint_name&gt;:&lt;image id&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can double check that your container is running and publishing the contents by using <code>CURL</code>. If you execute this command from the same VM that is publishing the OSTree repo you could use <code>localhost</code> as the IP, but it is always better to specify the actual IP address of the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IMAGE_BUILDER_IP=&lt;IP&gt;</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> If you didn&#8217;t use the Image Builder to run the container image publishing the OSTree repo, you will need to configure here the IP address of that system, not the Image Builder IP.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_input"></a>input</p>
</li>
<li>
<p><a id="tabset2_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl <a href="http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/repo/" class="bare">http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/repo/</a></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&lt;html&gt;
&lt;head&gt;&lt;title&gt;Index of /repo/&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor="white"&gt;
&lt;h1&gt;Index of /repo/&lt;/h1&gt;&lt;hr&gt;&lt;pre&gt;&lt;a href="../"&gt;../&lt;/a&gt;
&lt;a href="extensions/"&gt;extensions/&lt;/a&gt;                                 30-Nov-2022 09:17                   -
&lt;a href="objects/"&gt;objects/&lt;/a&gt;                                       30-Nov-2022 09:19                   -
&lt;a href="refs/"&gt;refs/&lt;/a&gt;                                             30-Nov-2022 09:17                   -
&lt;a href="state/"&gt;state/&lt;/a&gt;                                           30-Nov-2022 09:17                   -
&lt;a href="tmp/"&gt;tmp/&lt;/a&gt;                                               30-Nov-2022 09:19                   -
&lt;a href="config"&gt;config&lt;/a&gt;                                           30-Nov-2022 09:17                  38
&lt;/pre&gt;&lt;hr&gt;&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And if you want to be completely sure that the contents are the right ones, you can review the commit id:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_input"></a>input</p>
</li>
<li>
<p><a id="tabset3_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl <a href="http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/compose.json" class="bare">http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/compose.json</a></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">{"ref":"rhel/9/x86_64/edge","ostree-n-metadata-total":13593,"ostree-n-metadata-written":4573,"ostree-n-content-total":42606,"ostree-n-content-written":36966,"ostree-n-cache-hits":0,"ostree-content-bytes-written":2059379595,"ostree-commit":"a05cce6c8e34a609a484889b1e494484c4bc24b9c8a7374c2ae5573a1a15f1cc","ostree-content-checksum":"2fd316eacbe7b4ea42f24d97958290459c44294301f57638cc40c62b354bd847","ostree-version":"9.0","ostree-timestamp":"2022-11-30T09:19:31Z","rpm-ostree-inputhash":"cdae77f984cc529f21a7cb0d4ad80e9422b180140891fd42238f0b3606a203fa"}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Done!, you OSTree repo is now publised and ready to be used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rfe-iso"><a class="anchor" href="#rfe-iso"></a>Create the RHEL ISO</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are wondering when we include FDO in the RHEL for Edge image creation&#8230;&#8203; it&#8217;s now. So far you created an OSTree image and published in a HTTP server. You could already use it following the standard network based deployment (remember the <a href="https://github.com/luisarizmendi/rhel-edge-quickstart">different deployment options</a>) but in that case you wouldn&#8217;t be using FDO. If you want to make use of the FIDO Device Onboarding, you will need to create an ISO image containing the OSTree repository and pointing to the FDO Manufacturing server so you can embed the required certificates and keys.</p>
</div>
<div class="paragraph">
<p>Image Builder can also create an OSTree RHEL ISOs based on an already published OSTRee repository, and is as simple as creating a new Blueprint file (as you did to create the initial OSTree image).</p>
</div>
<div class="paragraph">
<p>This new Blueprint file will need, at least, info about the disk that will be used to install the system and the FDO manufacturing URL, so let&#8217;s create a couple of variables.</p>
</div>
<div class="paragraph">
<p>Regarding the disk, if you plan to use physical devices for the edge systems, you probably want to use something like <code>sda</code>, but if you are going to use VMs also for the edge devices (as you are doing with the Image Builder and FDO servers), use <code>vda</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">DISK_DEVICE=vda</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the FDO manufacturing server URL, you will need the IP address and the port (if you used the defaults, for the manufacturing server is <code>8080</code>). Remember that the VM where the FDO manufacturing server will depend on the option that you choose to deploy the FDO servers: All-in-one VS distributed services.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FDO_MANUFACTURING_URL="http://&lt;MANUFACTURING SERVER IP&gt;:&lt;MANUFACTURING SERVER PORT&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the new Blueprint file with these two values:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; blueprint-fdo.toml
name = "blueprint-fdo"
description = "Blueprint for FDO"
version = "0.0.1"
packages = []
modules = []
groups = []
distro = ""
[customizations]
installation_device = "/dev/${DISK_DEVICE}"
[customizations.fdo]
manufacturing_server_url = "${FDO_MANUFACTURING_URL}"
diun_pub_key_insecure = "true"
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Push again this new Blueprint file into the Image Builder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli blueprints push blueprint-fdo.toml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And check that the new Blueprint (the name that we used is <code>blueprint-fdo</code>) is ready to be used in the Image Builder (you will also find the Blueprint used to create the OSTree image):</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_input"></a>input</p>
</li>
<li>
<p><a id="tabset4_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli blueprints list</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">blueprint-fdo
kvm-insights</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Same as you did while creating the OSTree image, you will need to use this Blueprint to create the new image, but in this case, you will also need to include information about where the OSTree repo is published.</p>
</div>
<div class="paragraph">
<p>You should have already configured at this point two variables with the IP address and the TCP port where the repo is published: <code>${IMAGE_BUILDER_IP}</code> and <code>${IMAGE_PUBLISH_PORT}</code>, but you will also need to include the path (URL) to the right content which depends on the RHEL release and architecture used to generate the OSTRee image.</p>
</div>
<div class="paragraph">
<p>The release and the architecture should match with the ones of the Image Builder, so you can get those values running these commands into that VM:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">baserelease=$(cat /etc/redhat-release | awk '{print $6}' | awk -F . '{print $1}')
basearch=$(arch)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you have all the required values, run the actual command in the Image Builder that will create the ISO file with the embedded OSTree repository:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli compose start-ostree blueprint-fdo edge-simplified-installer --ref rhel/${baserelease}/${basearch}/edge --url <a href="http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/repo/" class="bare">http://${IMAGE_BUILDER_IP}:${IMAGE_PUBLISH_PORT}/repo/</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Review the status while the ISO is being created:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_input"></a>input</p>
</li>
<li>
<p><a id="tabset5_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo watch composer-cli compose status</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">51494368-35f7-471f-b0fa-c19b21709c8f RUNNING  Wed Nov 30 12:12:23 2022 blueprint-fdo   0.0.1 edge-simplified-installer
2d1030cb-6900-4e0b-994b-248c5bb55f7c FINISHED Wed Nov 30 10:19:41 2022 kvm-insights    0.0.1 edge-commit</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In my Image Builder VM with 2 vCPUs and 4 GB of memory this takes around 10 minutes.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the status changes to <code>FINISHED</code>, the ISO image will be ready in the Image Builder, you just need to download it.</p>
</div>
<div class="paragraph">
<p>In order to select the right image to download, you will need to include the generated ID that you found in the previous command. You can create a variable with it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FDO_ISO_IMAGE_ID=&lt;IMAGE ID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, download the ISO file from the Image Builder using the ID and change the owner if you are not using the <code>root</code> user:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo composer-cli compose image ${FDO_ISO_IMAGE_ID}
sudo chown $(whoami) ${FDO_ISO_IMAGE_ID}-simplified-installer.iso</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you should have an ISO file (downloaded in the Image Builder) that you can copy to your Laptop/KVM system to be used to deploy the Edge device in the next chapter.</p>
</div>
<div class="paragraph">
<p>If you feel that using an ISO file doesn&#8217;t scale in production you might be right. There is also a solution for that, you could publish the ISO image into an additional HTTP server and use the UEFI HTTP boot in the end Edge device to boot the ISO using the network. This deployment is not part of the lab, so I let you do it as homework. If you need some hints, you can dig into <a href="https://github.com/luisarizmendi/rhel-edge-quickstart/blob/master/2-publish-image.sh#L389">this script</a> that creates the additional HTTP server, includes the ISO and also gives you some comments about how to configure the KVM network if you are using VMs, or the DHCP if you are using physical devices in order to use UEFI HTTP boot.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rfe-summary"><a class="anchor" href="#rfe-summary"></a>RHEL OSTree image Lab summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you have:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the Image Builder service in RHEL</p>
</li>
<li>
<p>Create a OSTree RHEL image by:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Creating a blueprint file to customize the setup</p>
</li>
<li>
<p>Create a new OSTree repo</p>
</li>
<li>
<p>Publish the OStree repo</p>
</li>
<li>
<p>Create an ISO where you inject that OSTree repository</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You should have the created ISO image in your KVM host to use it as installation method for the edge device VM in the next lab.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-rfe-intro.html" class="query-params-link">2.a RHEL OSTree images - Intro</a></span>
  <span class="next"><a href="03-onboarding.html" class="query-params-link">3. Edge device onboarding - Lab</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
