<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FIDO Device Onboarding (FDO) - Lab :: Secure Edge device onboarding with RHEL and FDO</title>
    <link rel="canonical" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/fdo-tutorial/01-fdo-lab.html">
    <link rel="prev" href="01-fdo-intro.html">
    <link rel="next" href="02-rfe-intro.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/device-edge" target="_blank"><img
          src="../_/img/header_logo.png" height="50px" alt="Red Hat Device Edge"></a>
      <a class="navbar-item" style="color:white;font-size: 1.5rem" href="https://luisarizmendi.github.io/tutorial-secure-onboarding">Secure Edge device onboarding with RHEL and FDO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Repos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/fedora-iot/fido-device-onboard-rs" target="_blank">Fedora/RHEL FDO implementation</a>
            <a class="navbar-item" href="https://github.com/luisarizmendi/rhel-edge-quickstart" target="_blank">RHEL OSTree quickstart scripts</a>
            <a class="navbar-item" href="https://github.com/ansible-collections/community.fdo" target="_blank">FDO Ansible Collection</a>
            <a class="navbar-item" href="https://github.com/redhat-cop/infra.osbuild" target="_blank">Image Builder Ansible Collection</a>

          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Docs</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://fidoalliance.org/specs/FDO/FIDO-Device-Onboard-RD-v1.0-20201202.html" target="_blank">FDO Specification</a>
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/index" target="_blank">Red Hat documentation for RHEL OSTree</a>
            <a class="navbar-item" href="https://cloud.redhat.com/blog/introducing-the-new-red-hat-device-edge" target="_blank">Introducing Device Edge (RH Blog)</a>
            <a class="navbar-item" href="https://medium.com/@luis-javier-arizmendi-alonso/a-git-like-linux-operating-system-d84211e97933" target="_blank">RHEL OSTree article (Medium)</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Videos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://youtu.be/UxSKi6T_Vnc" target="_blank">Testing this lab</a>
            <a class="navbar-item" href="https://access.redhat.com/articles/5719641" target="_blank">RHEL OSTree demos</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Red Hat internal</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://docs.google.com/presentation/d/1FKQDHrleCPuE0e36UekzXdkw86wNDx16dSgllXj-swY/edit?usp=sharing" target="_blank">Red Hat Device Edge slide deck</a>
            <a class="navbar-item" href="https://drive.google.com/file/d/1DFSlbOYiMwnqqtUNU90dNGZClSGC0f3G/view?usp=share_link" target="_blank">FDO presentation video</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/rhs-openshift-starter-guides/4.9/index.html" target="_blank">OpenShift</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/acs-workshop/acs-workshop/index.html" target="_blank">ACM</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="fdo-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Secure Edge device onboarding with RHEL and FDO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-prerequisites.html">Lab prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#virtualization">Prepare your virtualization environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#arch">Choose your lab architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#usecase">Create your use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-intro.html">Introduction to secure edge device onboarding</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-scaling">Scaling traditional device deployment for the edge environments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-security">Device onboarding security and image templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-fdo">Centralizing the device onboarding intelligence</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html">1.a FDO - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-origins">FDO&#8217;s origins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-components">FDO components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow">FDO workflow</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-before">1. Before the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-during">2. During the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-after">3. After the first boot</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html">1.b FDO - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#fdo-services">FDO services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#fdo-services-aio">Option 1: All-in-one FDO server installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#fdo-services-dedicated">Option 2: Dedicated FDO servers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#fdo-config">FDO Service API config</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#fdo-optiona">Option A: Creating your own use case</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#fdo-optiona-user">initial_user</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#fdo-optiona-files">files</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#fdo-optiona-commands">commands</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#fdo-optiona-encrypt">diskencryption_clevis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#fdo-optionb">Option B: Using the example use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#fdo-summary">FDO Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-intro.html">2.a RHEL OSTree images - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-benefits">OSTree RHEL benefits for edge computing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-article">OSTree-based Operating Systems article</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-lab.html">2.b RHEL OSTree image - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-imagebuilder">Install Image builder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-lab.html#rfe-image">Create the RHEL OSTree image</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage">Generating the repo image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-optiona">Option A: Blueprint file for your own FDO onboarding automation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-optionb">Option B: Blueprint file for the provided FDO automation example</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-createrepo">Creating the OSTree repository</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-publish">Publishing the repo image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-iso">Create the RHEL ISO</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-summary">RHEL OSTree image Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-onboarding.html">3. Edge device onboarding - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-vm">Step 0 - Create the edge device VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-first">Step 1 - Edge device&#8217;s first boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-voucher">Step 2 - Distribute the Vouchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-finalboot">Step 3 - Automatic onboarding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-checks">Checking the edge device onboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-change">Updating the onboard automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-onboarding.html#onboard-summary">Edge device onboarding Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Secure Edge device onboarding with RHEL and FDO</a></li>
    <li><a href="01-fdo-lab.html">1.b FDO - Lab</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/luisarizmendi/tutorial-secure-onboarding/edit/master/documentation/modules/ROOT/pages/01-fdo-lab.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">FIDO Device Onboarding (FDO) - Lab</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you are going to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy and configured the FDO servers in one (Option 1) or multiple nodes (Option 2).</p>
</li>
<li>
<p>Customize the FDO onboarding automation with your own use case (Option A) or with the example automation provided in the lab (Option B).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Recently, a new <a href="https://github.com/ansible-collections/community.fdo/blob/main/examples/README.md">Ansible collection that helps configuring FDO</a> has been released but in this lab you will perform the steps manually to better understand the details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fdo-services"><a class="anchor" href="#fdo-services"></a>FDO services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FDO is a specification that has been implemented by multiple vendors. In this tutorial, we are going to use Red Hat development which is published upstream in <a href="https://github.com/fedora-iot/fido-device-onboard-rs">this GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>In this source code repository, you will find the implementation of the core FDO elements that we reviewed in the second article of the series along with the protocols that are used to exchange information between them.</p>
</div>
<div class="paragraph">
<p>As explained in the <a href="01-fdo-intro.html" class="xref page">introduction to FDO</a>, you will need at least three different servers: Manufacturing, Rendezvous and Owner server, but as mentioned in the <a href="00-prerequisites.html" class="xref page">Lab prerequisites</a>, for lab proposes you can choose between deploying those servers in a single system, or split them into dedicated servers, depending on your system resources. If you have enough CPU and RAM I suggest trying to split the services. Remember that multiple people could be involved in FDO server preparation. Maybe there is someone that will prepare the manufacturing server, another one, who could be in charge of the platform (or a 3rd party public cloud), will configure the Rendezvous Server, and someone else who will configure the boot automation steps on the owner server, so following this architecture you will be closer to what you could find in production.</p>
</div>
<div class="paragraph">
<p>Once you deployed your FDO services, you will also need to configure them to provide the onboarding automation. You could use your own automation or you can just deploy the provided example.</p>
</div>
<div class="paragraph">
<p>Choose your option ( <a href="#fdo-services-aio">Option 1</a> or <a href="#fdo-services-dedicated">Option 2</a>) and go ahead with the lab steps!</p>
</div>
<div class="sect2">
<h3 id="fdo-services-aio"><a class="anchor" href="#fdo-services-aio"></a>Option 1: All-in-one FDO server installation</h3>
<div class="paragraph">
<p>In order to minimize the number of servers used, you can install the FDO services in the same RHEL 8/9 server where you will install the <a href="02-rfe-lab.html#rfe-imagebuilder" class="xref page">Image builder</a> which is needed to create the RHEL for Edge images.</p>
</div>
<div class="paragraph">
<p>As part of the FDO development in Fedora/RHEL, a Systemd (<code>fdo-aio</code>) service that manages all the FDO servers has been created for lab proposes so it&#8217;s easy to deploy and manage the all-in-one option for the FDO services.</p>
</div>
<div class="paragraph">
<p><strong>Preparing the FDO services</strong></p>
</div>
<div class="paragraph">
<p>FDO is distributed as RPM packages, you can double check the names running this command in your RHEL VM:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_input"></a>input</p>
</li>
<li>
<p><a id="tabset1_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf search fdo</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">===================================================================================== Name &amp; Summary Matched: fdo ====================================================================
fdo-admin-cli.x86_64 : FDO admin tools implementation
fdo-client.x86_64 : FDO Client implementation
fdo-manufacturing-server.x86_64 : FDO Manufacturing Server
fdo-owner-cli.x86_64 : FDO Owner tools implementation
fdo-owner-onboarding-server.x86_64 : FDO Owner Onboarding Server
fdo-rendezvous-server.x86_64 : FDO Rendezvous Server implementation</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In order to install FDO services and the associated CLI, you can run the following command (this will install not only the manufacturing server, but also the <code>fdo-aio</code> service that you will be using in this section)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y fdo-admin-cli fdo-manufacturing-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have installed the packages, you can enable and run the <code>fdo-aio</code> Systemd service.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl enable --now fdo-aio</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are using the default keys and configuration (that we will modify later in the next section) but your FDO services should be already running in your VM:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_input"></a>input</p>
</li>
<li>
<p><a id="tabset2_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ss -ltn</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                 Recv-Q                Send-Q                               Local Address:Port                               Peer Address:Port               Process
LISTEN                0                     128                                        0.0.0.0:8080                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8081                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8082                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8083                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:22                                      0.0.0.0:*
LISTEN                0                     128                                           [::]:22                                         [::]:*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, you have services running in ports 8080-8081, so if you are running a firewall you should open those port too:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo firewall-cmd --add-port=8080-8083/tcp --permanent
sudo firewall-cmd --reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>fdo-aio</code> service create a directory (<code>/etc/fdo/aio</code>) and a file (<code>/etc/fdo/aio/aio_configuration</code>) where all the manufacturing, rendezvous and owner server parameters are specified</p>
</div>
<div class="paragraph">
<p>Below you can find an example of this configuration file generated by <code>fdo-aio</code>, probably similar to the one that you have in your server but with different IP addresses and Tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
cert_organization: FDO AIO
cert_country: US
listen_ip_address: 0.0.0.0
listen_port_manufacturing_server: 8080
listen_port_owner_onboarding_server: 8081
listen_port_rendezvous_server: 8082
listen_port_serviceinfo_api_server: 8083
separate_manufacturing_and_owner_voucher_store: false
manufacturing_enable_plain_di: false
manufacturing_disable_key_storage_filesystem: false
manufacturing_disable_key_storage_tpm: false
manufacturing_use_secp256r1: false
contact_hostname: ~
contact_addresses:
  - IpAddr: 192.168.122.187
  - IpAddr: "fe80::5054:ff:fe26:13c3"
serviceinfo_api_auth_token: dnEXugA+KXFpIDs7f0XFhn/hQ5FBcr+9d/MsMDfH7TM=
serviceinfo_api_admin_token: XWNzbEwQ6EWF+PWZrqa7d68mQFHG1NtGX9yklCNtMa8=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the directory <code>/etc/fdo/aio</code> you will also find the configuration files generated for the FDO servers along with the default certificates and keys.</p>
</div>
<div class="paragraph">
<p>You can now proceed with the <a href="#fdo-config">FDO Service API configuration</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="fdo-services-dedicated"><a class="anchor" href="#fdo-services-dedicated"></a>Option 2: Dedicated FDO servers</h3>
<div class="paragraph">
<p>In this option, you will have the Image Builder server and 3 additional FDO VMs (Manufacturing, Rendezvous and Owner). If you find that architecture requires too many resources but you still want to test the FDO split into different servers, you could install one of those (maybe the manufacturing server) in the same VM as the Image Builder in order to save some CPU and Memory.</p>
</div>
<div class="paragraph">
<p><strong>Manufacturing server</strong></p>
</div>
<div class="paragraph">
<p>Start by installing the required RPMs:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y fdo-admin-cli fdo-manufacturing-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you remember, during the manufacturing phase you have to “inject” certain certificates and keys into your device. When using the All-in-One FDO server model those are generated automatically, but if you split the services you need to create them manually.</p>
</div>
<div class="paragraph">
<p>Create a directory where to place the certs and keys:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir /etc/fdo/keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>fdo-admin-tool</code> that you have installed to create those secrets. There are four groups: “manufacturer”, “owner”, “device-ca”, and “diun” (Device Initialize over Untrusted Networks certs and keys for communication):</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">for i in manufacturer owner device-ca diun
do
  sudo fdo-admin-tool generate-key-and-cert --destination-dir /etc/fdo/keys $i
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the certificates and keys have been created in the correct directory:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_input"></a>input</p>
</li>
<li>
<p><a id="tabset3_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls /etc/fdo/keys/</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">device_ca_cert.pem  device_ca_key.der  diun_cert.pem  diun_key.der  manufacturer_cert.pem  manufacturer_key.der  owner_cert.pem  owner_key.der</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The manufacturer service also stores other components, such as the owner vouchers, the manufacturer keys, and information about the manufacturing sessions. Create a dedicated directory for each:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir -p /etc/fdo/stores/manufacturer_keys
sudo mkdir -p /etc/fdo/stores/manufacturing_sessions
sudo mkdir -p /etc/fdo/stores/owner_vouchers</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s time to configure the Manufacturing server. You can find an example configuration in <code>/usr/share/doc/fdo/manufacturing-server.yml</code>. Create your own configuration in the <code>/etc/fdo/manufacturing-server.yml</code> file using that template.</p>
</div>
<div class="paragraph">
<p>Here you can find another configuration example, if you change the Rendezvous IP address (example IP <code>192.168.122.99</code> under <code>rendezvous_info</code>) to your actual Rendezvous server IP it would be everything that you need to do if you use this file and follow the lab steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
session_store_driver:
  Directory:
    path: /etc/fdo/stores/manufacturing_sessions/
ownership_voucher_store_driver:
  Directory:
    path: /etc/fdo/stores/owner_vouchers
public_key_store_driver:
  Directory:
    path: /etc/fdo/stores/manufacturer_keys
bind: "0.0.0.0:8080"
protocols:
  plain_di: false
  diun:
    mfg_string_type: SerialNumber
    key_type: SECP384R1
    allowed_key_storage_types:
      - Tpm
      - FileSystem
    key_path: /etc/fdo/keys/diun_key.der
    cert_path: /etc/fdo/keys/diun_cert.pem
rendezvous_info:
  - deviceport: 8082
    ip_address: 192.168.122.99
    ownerport: 8082
    protocol: http
manufacturing:
  manufacturer_cert_path: /etc/fdo/keys/manufacturer_cert.pem
  device_cert_ca_private_key: /etc/fdo/keys/device_ca_key.der
  device_cert_ca_chain: /etc/fdo/keys/device_ca_cert.pem
  owner_cert_path: /etc/fdo/keys/owner_cert.pem
  manufacturer_private_key: /etc/fdo/keys/manufacturer_key.der</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration contains the paths to the directories, certificates, and keys you created, along with the Rendezvous server IP address and port (the default is 8082). I configured one Rendezvous server, but you can include more.</p>
</div>
<div class="paragraph">
<p>Once <code>/etc/fdo/manufacturing-server.yml</code> is prepared, you can start the Manufacturing server. First, check that you have the systemd unit file in the server:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_input"></a>input</p>
</li>
<li>
<p><a id="tabset4_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl list-unit-files | grep fdo | grep manufac</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">fdo-manufacturing-server.service disabled disabled</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enable and start it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl enable --now fdo-manufacturing-server.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>And check that the service is listening on port 8080 (default)</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_input"></a>input</p>
</li>
<li>
<p><a id="tabset5_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo ss -ltn</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                       Recv-Q                      Send-Q                                           Local Address:Port                                            Peer Address:Port                      Process
LISTEN                      0                           128                                                    0.0.0.0:8080                                                 0.0.0.0:*
LISTEN                      0                           128                                                    0.0.0.0:22                                                   0.0.0.0:*
LISTEN                      0                           128                                                       [::]:22                                                      [::]:*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Remember to open the required ports in your firewall (if you are using any):</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo firewall-cmd --add-port=8080/tcp --permanent
sudo systemctl restart firewalld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s move to the next server, the Rendezvous server.</p>
</div>
<div class="paragraph">
<p><strong>Rendezvous server</strong></p>
</div>
<div class="paragraph">
<p>Connect to the RHEL VM where you want to install the Rendezvous server and, as you did with the Manufacturing server, install the required RPM packages:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y fdo-rendezvous-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a directory for the required certificates:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir -p /etc/fdo/keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Rendezvous server needs the <code>manufacturer_cert.pem</code> certificate you created in the Manufacturing server, so copy it from the Manufacturing server into the <code>/etc/fdo/keys</code> directory in this Rendezvous server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo scp &lt;user&gt;@&lt;manufacturing IP&gt;:/etc/fdo/keys/manufacturer_cert.pem /etc/fdo/keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you did with the Manufacturing server, create the directories needed by the Rendezvous server, including the registered directory (where the registered device owner vouchers will be hosted) and the sessions directory:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir -p /etc/fdo/stores/rendezvous_registered
sudo mkdir -p /etc/fdo/stores/rendezvous_sessions</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the configuration file in <code>/etc/fdo/rendezvous-server.yml</code>. You can find an example in <code>/usr/share/doc/fdo/rendezvous-server.yml</code>. If you followed the steps shown above,  the path to the <code>manufacturer_cert.pem</code> certificate should be in the <code>/etc/fdo/keys</code> directory, as shown in below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
storage_driver:
  Directory:
    path: /etc/fdo/stores/rendezvous_registered
session_store_driver:
  Directory:
    path: /etc/fdo/stores/rendezvous_sessions
trusted_manufacturer_keys_path: /etc/fdo/keys/manufacturer_cert.pem
max_wait_seconds: ~
bind: "0.0.0.0:8082"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the status of the Rendezvous server service:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_input"></a>input</p>
</li>
<li>
<p><a id="tabset6_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl list-unit-files | grep fdo | grep rende</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">fdo-rendezvous-server.service disabled disabled</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Since it&#8217;s probably stopped and disabled, enable and start it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl enable --now fdo-rendezvous-server.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the server is listening on the configured port (default 8082):</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_input"></a>input</p>
</li>
<li>
<p><a id="tabset7_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo ss -ltn</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                       Recv-Q                      Send-Q                                           Local Address:Port                                            Peer Address:Port                      Process
LISTEN                      0                           128                                                    0.0.0.0:8082                                                 0.0.0.0:*
LISTEN                      0                           128                                                    0.0.0.0:22                                                   0.0.0.0:*
LISTEN                      0                           128                                                       [::]:22                                                      [::]:*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And remember to open the port if you have a firewall configured on this server:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo firewall-cmd --add-port=8082/tcp --permanent
sudo systemctl restart firewalld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Move to the third and last FDO server: the Owner server.</p>
</div>
<div class="paragraph">
<p><strong>Owner server</strong></p>
</div>
<div class="paragraph">
<p>Connect to the dedicated RHEL VM and install the required RPMs in this server:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y fdo-owner-cli fdo-owner-onboarding-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the certificate and keys directory:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir -p /etc/fdo/keys/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <code>device_ca_cert.pem</code>, <code>owner_key.der</code>, and <code>owner_cert.pem</code> certificates from the Manufacturing server into that new directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">for i in device_ca_cert.pem owner_key.der owner_cert.pem
do
  sudo scp &lt;user&gt;@&lt;manufacturing IP&gt;:/etc/fdo/keys/$i /etc/fdo/keys
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the additional directories needed by the owner service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mkdir -p /etc/fdo/stores/owner_vouchers
sudo mkdir -p /etc/fdo/stores/owner_onboarding_sessions</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prepare a configuration file in <code>/etc/fdo/owner-onboarding-server.yml</code> based on the example found in <code>/usr/share/doc/fdo/owner-onboarding-server.yml</code>. If you are following the lab steps, changing the Owner IP address would be enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
ownership_voucher_store_driver:
  Directory:
    path: /etc/fdo/stores/owner_vouchers
session_store_driver:
  Directory:
    path: /etc/fdo/stores/owner_onboarding_sessions
trusted_device_keys_path: /etc/fdo/keys/device_ca_cert.pem
owner_private_key_path: /etc/fdo/keys/owner_key.der
owner_public_key_path: /etc/fdo/keys/owner_cert.pem
bind: "0.0.0.0:8081"
service_info_api_url: "http://localhost:8083/device_info"
service_info_api_authentication:
  BearerToken:
    token: Kpt5P/5flBkaiNSvDYS3cEdBQXJn2Zv9n1D50431/lo=
owner_addresses:
  - transport: http
    addresses:
      - ip_address: 192.168.122.149
    port: 8081
report_to_rendezvous_endpoint_enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this file, we include the path to the certificates that we already copied, along with information about where to publish the owner server service, but you will also find references to “Info API Service”, such as the URL or the authentication token.</p>
</div>
<div class="paragraph">
<p>This service will be configured in the Owner sever, but since that&#8217;s a step that is needed also when you install all FDO services on the same node, it will be explained more in detail in the next section.</p>
</div>
<div class="paragraph">
<p>Also, as you can see, we have configured the Serviceinfo API authentication by providing a Bearer Token. This Token will be needed in the Serviceinfo API configuration below.</p>
</div>
<div class="paragraph">
<p>Before moving into the FDO Serviceinfo API configuration, check the status of the Owner server and the serviceinfo API service:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_input"></a>input</p>
</li>
<li>
<p><a id="tabset8_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl list-unit-files | grep fdo</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset8_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">fdo-owner-onboarding-server.service        disabled        disabled
fdo-serviceinfo-api-server.service         disabled        disabled</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enable them if necessary:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl enable fdo-owner-onboarding-server.service
sudo systemctl enable fdo-serviceinfo-api-server.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>And start the Owner server (you will start the Serviceinfo API once you configured it in the next section)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl start fdo-owner-onboarding-server.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the Owner server is listening in the configured port (TCP/8081 is the default port for the Owner server):</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset9_input"></a>input</p>
</li>
<li>
<p><a id="tabset9_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset9_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo ss -ltn</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset9_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                       Recv-Q                      Send-Q                                           Local Address:Port                                            Peer Address:Port                      Process
LISTEN                      0                           128                                                    0.0.0.0:22                                                   0.0.0.0:*
LISTEN                      0                           128                                                    0.0.0.0:8081                                                 0.0.0.0:*
LISTEN                      0                           128                                                       [::]:22                                                      [::]:*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And remember to open the ports if you have a firewall configured in that server (both the TCP/8081 for the Owner server and the TCP/8083 for the Serviceinfo API):</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo firewall-cmd --add-port=8081/tcp --permanent
sudo firewall-cmd --add-port=8083/tcp --permanent
sudo systemctl restart firewalld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s time for the Serviceinfo API configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fdo-config"><a class="anchor" href="#fdo-config"></a>FDO Service API configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What is this Info API Service?</p>
</div>
<div class="paragraph">
<p>In the FDO RHEL implementation, you find this “Service Info API” which we will be using to introduce the “automation” needed as part of the onboarding, by including the ssh key, files to be copied/created, commands to be executed, disk to be encrypted, etc.</p>
</div>
<div class="paragraph">
<p>The service is configured using a YAML file located under <code>/etc/fdo/serviceinfo-api-server.yml</code> if you splitted the FDO services or in <code>/etc/fdo/aio/configs/serviceinfo_api_server.yml</code> if you used the all-in-one approach.</p>
</div>
<div class="paragraph">
<p>There is an example of this located in <code>/usr/share/doc/fdo/serviceinfo-api-server.yml</code> that can be used as a template to create your own configuration file. You can also review the default configuration (in this case is for the all-in-one setup, you can know it by taking a look at the stores path):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
service_info:
  initial_user: ~
  files: ~
  commands: ~
  diskencryption_clevis: ~
  additional_serviceinfo: ~
bind: "0.0.0.0:8083"
service_info_auth_token: dnEXugA+KXFpIDs7f0XFhn/hQ5FBcr+9d/MsMDfH7TM=
admin_auth_token: XWNzbEwQ6EWF+PWZrqa7d68mQFHG1NtGX9yklCNtMa8=
device_specific_store_driver:
  Directory:
    path: /etc/fdo/aio/stores/serviceinfo_api_devices</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s time to configure your own automation use case, so prepare your files and scripts before moving on! &#8230;&#8203; or <a href="#fdo-optionb">jump into the section</a> where it is explained how to use the provided onboarding automation example.</p>
</div>
<div class="sect2">
<h3 id="fdo-optiona"><a class="anchor" href="#fdo-optiona"></a>Option A: Creating your own use case</h3>
<div class="paragraph">
<p>In the <code>serviceinfo_api_server.yml</code> file you find the following sections that you can use to build your own onboarding experience.</p>
</div>
<div id="fdo-optiona-user" class="paragraph">
<p><strong>initial_user</strong></p>
</div>
<div class="paragraph">
<p>We start with the initial user. The RHEL image only has configured the root user, and it has no password by default so you need to include an additional user that you can use to access the device by using a public SSH key.</p>
</div>
<div class="paragraph">
<p>In our specific case, where we are using a combination of FDO and OSTree RHEL, there is something more that you should take into account. As you will see in the following modules, when you create an OSTree RHEL image, you use a blueprint file where you can also include a "initial user" so, what&#8217;s the one that should be used?</p>
</div>
<div class="paragraph">
<p>The answer is the one that you create with the RHEL for Edge blueprint, so if you configure a user in your <code>serviceinfo_api_server.yml</code> (I do) be sure that you use the same username and SSH key.</p>
</div>
<div class="paragraph">
<p>Here you can find a configuration example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  initial_user:
    username: admin
    sshkeys:
    - "ssh-rsa AAAA...."</code></pre>
</div>
</div>
<div id="fdo-optiona-files" class="paragraph">
<p><strong>files</strong></p>
</div>
<div class="paragraph">
<p>The next section in the configuration is <code>files</code>, which can be used to transfer files to the devices. You need to include the source and destination paths along with the permissions to be setup in the device.</p>
</div>
<div class="paragraph">
<p>There is something more to bear in mind with this configuration. At this moment <a href="https://github.com/fedora-iot/fido-device-onboard-rs/issues/289">you cannot copy files to a destination path that is not already created in the destination image</a>, for example, you can not copy file example.txt to` /etc/newdir/other` since that destination directory is not present in the RHEL for Edge image.</p>
</div>
<div class="paragraph">
<p>If you need to copy files at the same time that you need to create directories, an option would be to copy a <code>tar</code> file with the definitive directory tree, and use the <code>commands</code> (explained later) to untar that file in the destination. By doing so, when you uncompress the file the same directory tree will be created in the destination.</p>
</div>
<div class="paragraph">
<p>This is a configuration example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  - path: /etc/greenboot/check/required.d/01_check_demo_file.sh
    permissions: 644
    source_path: /etc/fdo-configs/device0/etc/greenboot/check/required.d/01_check_demo_file.sh</code></pre>
</div>
</div>
<div id="fdo-optiona-commands" class="paragraph">
<p><strong>commands</strong></p>
</div>
<div class="paragraph">
<p>Thanks to the <code>commands</code> section you can configure commands that will be run as part of the onboarding process (after copying the files of the previous section).</p>
</div>
<div class="paragraph">
<p>Just remember that at this moment <a href="https://github.com/fedora-iot/fido-device-onboard-rs/issues/290">you cannot use constructs such as &gt;&gt; or &amp;&amp; in the commands</a>. If you "need" to use constructs you can create a bash script file, copy and make it executable using the <code>files</code> section and then run that script (<code>commands</code> section).</p>
</div>
<div class="paragraph">
<p>In order to configure the section, you will need to include the <code>command</code> followed by the <code>args</code> each on one line. You can also include optional boolean variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>may_fail</code>: makes it possible to continue with the onboarding even if this command fails (default is false)</p>
</li>
<li>
<p><code>return_stdout</code>: the command will return the standard output (default is false).</p>
</li>
<li>
<p><code>return_stderr</code>: has the same effect as <code>return_stdout</code> but with the errors (default is false).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This would be an example with all the variables, including the optional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  - command: systemctl
    args:
    - enable
    - --now
    - rpm-ostreed-automatic.timer
    may_fail: true
    return_stdout: true
    return_stderr: true</code></pre>
</div>
</div>
<div id="fdo-optiona-encrypt" class="paragraph">
<p><strong>diskencryption_clevis</strong></p>
</div>
<div class="paragraph">
<p>If configured, it will perform a disk encryption using <a href="https://wiki.archlinux.org/title/Clevis">Clevis</a>.</p>
</div>
<div class="paragraph">
<p>You need to include at least which disk or partition you want to encrypt (<code>disk_label</code>), and the encryption method (<code>pin</code>).</p>
</div>
<div class="paragraph">
<p>You can use either a file to save the encryption keys (which is not secure) or a Trusted Platform Module (TPM) in your device. Be sure that if you select TPM your device or virtual machine will need to have a TPM module, or you will get an error like this one when booting the edge device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> 2022-11-30T11:33:32.516Z INFO  fdo_client_linuxapp::serviceinfo &gt; Initiating disk re-encryption, disk-label: /dev/vda&gt;
 2022-11-30T11:33:32.945Z INFO  fdo_client_linuxapp              &gt; ServiceInfo failed, error: Error processing returne&gt;
Caused by:
    0: Error executing clevis
    1: Error executing disk encryption for disk label /dev/vda4
    2: Error rebinding clevis
    3: Error binding clevis
    4: Failed to bind clevis: ExitStatus(unix_wait_status(256)), stdout: , stderr:
       A TPM2 device with the in-kernel resource manager is needed!
       Invalid input!</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is an additional boolean variable, <code>reencrypt</code>,  that is needed to decide if Clevis has to reecrypt a disk if it has been already encrypted. As mentioned before, in this tutorial we are using OSTree RHEL, which by default encrypts the OS partition, so if you want to test this feature be sure that you set this boolean variable to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>This is a configuration example where TPM is used to reencrypt the <code>/dev/vda4</code> which is the default partition where the OS is mounted RHEL for Edge devices with a small disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  diskencryption_clevis:
  - disk_label: /dev/vda4
    binding:
      pin: tpm2
      config: "{}"
    reencrypt: true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fdo-optionb"><a class="anchor" href="#fdo-optionb"></a>Option B: Using the example use case</h3>
<div class="paragraph">
<p>Download the example <code>serviceinfo_api_server.yml</code> file:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -O <a href="https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/serviceinfo_api_server.yml" class="bare">https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/serviceinfo_api_server.yml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Download and extract the files required by the onboarding automation:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -O <a href="https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/fdo-configs.tar.gz" class="bare">https://raw.githubusercontent.com/luisarizmendi/tutorial-secure-onboarding/master/documentation/modules/ROOT/examples/fdo-configs.tar.gz</a>
tar xvf fdo-configs.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Probably you don&#8217;t want to use your home directory, so copy the files into another definitive location, for example <code>/etc</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo cp -r fdo-configs/ /etc</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to type that directory, create a variable that you can use in the commands proposed below in this section (do not include the last <code>/</code>)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">PATH_FILES="/etc/fdo-configs"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You now have both the configuration and the required files, but you still need to customize the former to make it work in your environment.</p>
</div>
<div class="paragraph">
<p>Starting for including your own public SSH key that will be used to SSH into the edge devices. For the same reason that you created a variable with the file config directory path, you can create a new variable with your SSH public key, so you can use the <code>sed</code> commands shown below in this section. Another different option would be to type those parameters directly on the Serviceinfo API file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SSH_PUB_KEY="ssh-rsa AAAAB3......am8= user@machine"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The onboarding automation will register your system in the <a href="https://console.redhat.com">Red Hat Hybrid Console</a> so the file will need your Red Hat account credentials. In order to not include the user and password directly in plain text, the script that I created accepts the inputs as base64 (for a production environment you should write a script that accepts encrypted passwords, not just with base64).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">RED_HAT_USER=$(echo "&lt;YOUR RED HAT USER&gt;" | base64 )
RED_HAT_PASSWORD=$(echo "&lt;YOUR RED HAT PASSWORD&gt;" | base64 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example Serviceinfo API file doesn&#8217;t have the right tokens, so update it with the ones on your system. There are two tokens, <code>service_info_auth_token</code> is the authorization token configured in the Owner server (you can use <code>None</code> if no authentication is needed) and the <code>admin_auth_token</code> that is the admins authorization token (this variable is optional but since it&#8217;s configured when following the All-in-One approach, here we also configure it for the distributed method for consistency.)</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Be sure that you use the commands for the FDO deployment option that you selected (all-in-one versus dedicated servers) since the directory where you find <code>serviceinfo_api_server.yml</code> file is different</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset10_all-in-one-server"></a>All-in-one server</p>
</li>
<li>
<p><a id="tabset10_dedicated-servers"></a>Dedicated servers</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset10_all-in-one-server">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SERVICE_TOKEN=$(grep service_info_auth_token /etc/fdo/aio/configs/serviceinfo_api_server.yml | awk '{print $2}')
ADMIN_TOKEN=$(grep admin_auth_token /etc/fdo/aio/configs/serviceinfo_api_server.yml | awk '{print $2}')</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset10_dedicated-servers">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SERVICE_TOKEN=$(grep token /etc/fdo/owner-onboarding-server.yml  | awk '{print $2}')
ADMIN_TOKEN=$(grep token /etc/fdo/owner-onboarding-server.yml  | awk '{print $2}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, use these variables to update the example <code>serviceinfo-api-server.yml</code> file that you downloaded:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -i "s|&lt;SSH PUB KEY&gt;|${SSH_PUB_KEY}|g" serviceinfo_api_server.yml
sed -i "s|&lt;PATH FILES&gt;|${PATH_FILES}|g" serviceinfo_api_server.yml
sed -i "s|&lt;RED HAT USER&gt;|${RED_HAT_USER}|g" serviceinfo_api_server.yml
sed -i "s|&lt;RED HAT PASSWORD&gt;|${RED_HAT_PASSWORD}|g" serviceinfo_api_server.yml
sed -i "s|&lt;SERVICE TOKEN&gt;|${SERVICE_TOKEN}|g" serviceinfo_api_server.yml
sed -i "s|&lt;ADMIN TOKEN&gt;|${ADMIN_TOKEN}|g" serviceinfo_api_server.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then copy this file into the final directory (choose your FDO deployment option).</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset11_all-in-one-server"></a>All-in-one server</p>
</li>
<li>
<p><a id="tabset11_dedicated-servers"></a>Dedicated servers</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset11_all-in-one-server">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo cp -f serviceinfo_api_server.yml  /etc/fdo/aio/configs/serviceinfo_api_server.yml</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset11_dedicated-servers">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo cp -f serviceinfo_api_server.yml /etc/fdo/serviceinfo-api-server.yml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that you have the configuration in plase, start or restart the service</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Every time you change the configuration files, remember to restart the systemd services.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset12_all-in-one-server"></a>All-in-one server</p>
</li>
<li>
<p><a id="tabset12_dedicated-servers"></a>Dedicated servers</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset12_all-in-one-server">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl restart fdo-aio</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset12_dedicated-servers">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl restart fdo-serviceinfo-api-server.service</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If everything is ok, you will find that the FDO servers are up and running. Check if the services are listening in their ports, if the port 8083 is not up, probably there is something wrong in your serviceinfo_api_server configuration. Most of the time the logs don&#8217;t not help, so try to remove some parts of the <code>serviceinfo_api_server.yml</code> file and restart the service until you find the port listening, then try to figure out the error (files are not in the path?, malformed command?, etc ).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset13_input"></a>input</p>
</li>
<li>
<p><a id="tabset13_output-in-all-in-one"></a>output (in All-in-one)</p>
</li>
<li>
<p><a id="tabset13_output-dedicated-servers"></a>output (Dedicated servers)</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset13_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ss -ltn</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset13_output-in-all-in-one">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                 Recv-Q                Send-Q                               Local Address:Port                               Peer Address:Port               Process
LISTEN                0                     128                                        0.0.0.0:8080                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8081                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8082                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:8083                                    0.0.0.0:*
LISTEN                0                     128                                        0.0.0.0:22                                      0.0.0.0:*
LISTEN                0                     128                                           [::]:22                                         [::]:*</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset13_output-dedicated-servers">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">State                       Recv-Q                      Send-Q                                           Local Address:Port                                            Peer Address:Port                      Process
LISTEN                      0                           128                                                    0.0.0.0:22                                                   0.0.0.0:*
LISTEN                      0                           128                                                    0.0.0.0:8081                                                 0.0.0.0:*
LISTEN                      0                           128                                                    0.0.0.0:8083                                                 0.0.0.0:*
LISTEN                      0                           128                                                       [::]:22                                                      [::]:*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you find a message on the Serviceinfo logs that says that there is a missing field <code>service_info</code>, that could mean that the path to your <code>serviceinfo_api_server.yml</code> file is not the right one (remember that it is different depending if you are using the All-in-One FDO server or not).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fdo-summary"><a class="anchor" href="#fdo-summary"></a>FDO Lab summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you have:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deployed and configured the FDO servers in one or multiple nodes.</p>
</li>
<li>
<p>Configured the FDO Service API which will enforce the onboarding automation in the edge device with your own use case or with the example automation provided in the lab.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that you have the FDO services ready, you need to use them. You could get a standard RHEL and install the <code>fdo-client</code> package and configure it to use the servers that you deployed, but in this tutorial we are going to use OSTree RHEL which already includes the <code>fdo-client</code> and all required configurations by default when you create one of these OSTree images with the <a href="https://developers.redhat.com/blog/2019/05/08/red-hat-enterprise-linux-8-image-builder-building-custom-system-images">Red Hat Image builder</a>.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-fdo-intro.html" class="query-params-link">1.a FDO - Intro</a></span>
  <span class="next"><a href="02-rfe-intro.html" class="query-params-link">2.a RHEL OSTree images - Intro</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
