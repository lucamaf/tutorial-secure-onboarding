<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Edge device onboarding :: Secure Edge device onboarding with RHEL and FDO</title>
    <link rel="canonical" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/fdo-tutorial/03-onboarding.html">
    <link rel="prev" href="02-rfe-lab.html">
    <link rel="next" href="99-summary.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/device-edge" target="_blank"><img
          src="../_/img/header_logo.png" height="50px" alt="Red Hat Device Edge"></a>
      <a class="navbar-item" style="color:white;font-size: 1.5rem" href="https://luisarizmendi.github.io/tutorial-secure-onboarding">Secure Edge device onboarding with RHEL and FDO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Repos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/fedora-iot/fido-device-onboard-rs" target="_blank">Fedora/RHEL FDO implementation</a>
            <a class="navbar-item" href="https://github.com/luisarizmendi/rhel-edge-quickstart" target="_blank">RHEL OSTree quickstart scripts</a>
            <a class="navbar-item" href="https://github.com/ansible-collections/community.fdo" target="_blank">FDO Ansible Collection</a>
            <a class="navbar-item" href="https://github.com/redhat-cop/infra.osbuild" target="_blank">Image Builder Ansible Collection</a>

          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Docs</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://fidoalliance.org/specs/FDO/FIDO-Device-Onboard-RD-v1.0-20201202.html" target="_blank">FDO Specification</a>
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/index" target="_blank">Red Hat documentation for RHEL OSTree</a>
            <a class="navbar-item" href="https://cloud.redhat.com/blog/introducing-the-new-red-hat-device-edge" target="_blank">Introducing Device Edge (RH Blog)</a>
            <a class="navbar-item" href="https://medium.com/@luis-javier-arizmendi-alonso/a-git-like-linux-operating-system-d84211e97933" target="_blank">RHEL OSTree article (Medium)</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Videos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://youtu.be/UxSKi6T_Vnc" target="_blank">Testing this lab</a>
            <a class="navbar-item" href="https://access.redhat.com/articles/5719641" target="_blank">RHEL OSTree demos</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Red Hat internal</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://docs.google.com/presentation/d/1FKQDHrleCPuE0e36UekzXdkw86wNDx16dSgllXj-swY/edit?usp=sharing" target="_blank">Red Hat Device Edge slide deck</a>
            <a class="navbar-item" href="https://drive.google.com/file/d/1DFSlbOYiMwnqqtUNU90dNGZClSGC0f3G/view?usp=share_link" target="_blank">FDO presentation video</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/rhs-openshift-starter-guides/4.9/index.html" target="_blank">OpenShift</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/acs-workshop/acs-workshop/index.html" target="_blank">ACM</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="fdo-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Secure Edge device onboarding with RHEL and FDO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-prerequisites.html">Lab prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#virtualization">Prepare your virtualization environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#arch">Choose your lab architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-prerequisites.html#usecase">Create your use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-intro.html">Introduction to secure edge device onboarding</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-scaling">Scaling traditional device deployment for the edge environments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-security">Device onboarding security and image templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-intro.html#intro-fdo">Centralizing the device onboarding intelligence</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html">1.a FDO - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-origins">FDO&#8217;s origins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-components">FDO components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow">FDO workflow</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-before">1. Before the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-during">2. During the first boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-intro.html#fdo-intro-workflow-after">3. After the first boot</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html">1.b FDO - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-services">FDO services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-services-aio">Option 1: All-in-one FDO server installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-services-dedicated">Option 2: Dedicated FDO servers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-config">FDO Service API config</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona">Option A: Creating your own use case</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-user">initial_user</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-files">files</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-commands">commands</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optiona-encrypt">diskencryption_clevis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-fdo-lab.html#fdo-optionb">Option B: Using the example use case</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-fdo-lab.html#fdo-summary">FDO Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-intro.html">2.a RHEL OSTree images - Intro</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-benefits">OSTree RHEL benefits for edge computing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-intro.html#rfe-intro-article">OSTree-based Operating Systems article</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-lab.html">2.b RHEL OSTree image - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-imagebuilder">Install Image builder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-rfe-lab.html#rfe-image">Create the RHEL OSTree image</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage">Generating the repo image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-optiona">Option A: Blueprint file for your own FDO onboarding automation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-optionb">Option B: Blueprint file for the provided FDO automation example</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-ostreeimage-createrepo">Creating the OSTree repository</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-rfe-lab.html#rfe-publish">Publishing the repo image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-iso">Create the RHEL ISO</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-rfe-lab.html#rfe-summary">RHEL OSTree image Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-onboarding.html">3. Edge device onboarding - Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-vm">Step 0 - Create the edge device VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-first">Step 1 - Edge device&#8217;s first boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-voucher">Step 2 - Distribute the Vouchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-finalboot">Step 3 - Automatic onboarding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-checks">Checking the edge device onboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-change">Updating the onboard automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#onboard-summary">Edge device onboarding Lab summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Secure Edge device onboarding with RHEL and FDO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Secure Edge device onboarding with RHEL and FDO</a></li>
    <li><a href="03-onboarding.html">3. Edge device onboarding - Lab</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/luisarizmendi/tutorial-secure-onboarding/edit/master/documentation/modules/ROOT/pages/03-onboarding.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Edge device onboarding</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you are going to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a VM that will act as edge device</p>
</li>
<li>
<p>Use the FDO enabled RHEL OSTree ISO image to install the edge device</p>
</li>
<li>
<p>Review the onboarding process and completion</p>
</li>
<li>
<p>Include changes into the device onboarding automation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first step for this lab will be creating a VM that will act as edge device. If you are using a physical device you can of course skip this step.</p>
</div>
<div class="paragraph">
<p>After creating the VM, you will run the onboarding process. This process differs a little bit depending if you are using the All-in-One FDO server or the distributed approach.</p>
</div>
<div class="paragraph">
<p>In production, where you have the FDO services split in multiple servers, you will find 3 steps during the onboarding:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First boot and system preinstallation</p>
</li>
<li>
<p>Voucher distribution</p>
</li>
<li>
<p>Device Onboarding</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Those steps will be explained below, but you need to know that, if you are using the All-in-One FDO server, these three steps will be reduced to just one, where the device is preconfigured, the vouchers are automatically distributed (because it&#8217;s just a local copy of files inside the same server), and the onboarding happens just right after the device&#8217;s first boot. Comments about this will be included in each section but please, bear this in mind.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-vm"><a class="anchor" href="#onboard-vm"></a>Step 0 - Create the edge device VM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need to create a VM with at least 2 vCPUs, 1.5GB memory, 20GB of disk and a NIC in a network with DHCP and Internet access.</p>
</div>
<div class="paragraph">
<p>Use the ISO installation method for the Operating System and point to the RHEL OSTree ISO that you created in the last LAB.</p>
</div>
<div class="paragraph">
<p><strong>Before</strong> booting the VM, be sure that it will use UEFI instead of legacy BOOT (since the created ISO is prepared to use UEFI by default), otherwise you will get a <code>code 0009</code> error while booting.</p>
</div>
<div class="paragraph">
<p>Lastly, if you configured in the Serviceinfo_API configuration file that you want to use a TPM, be sure that you add a virtual TPM in your VM or you will get the following error that will prevent FDO onboarding to complete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> 2022-11-30T11:33:32.516Z INFO  fdo_client_linuxapp::serviceinfo &gt; Initiating disk re-encryption, disk-label: /dev/vda&gt;
 2022-11-30T11:33:32.945Z INFO  fdo_client_linuxapp              &gt; ServiceInfo failed, error: Error processing returne&gt;
Caused by:
    0: Error executing clevis
    1: Error executing disk encryption for disk label /dev/vda4
    2: Error rebinding clevis
    3: Error binding clevis
    4: Failed to bind clevis: ExitStatus(unix_wait_status(256)), stdout: , stderr:
       A TPM2 device with the in-kernel resource manager is needed!
       Invalid input!
       Usage: jose jwe fmt -i JWE [-I CT] [-o JWE] [-O CT] [-c]

       Converts a JWE between serialization formats

         -i JSON --input=JSON     Parse JWE from JSON
         -i FILE --input=FILE     Read JWE from FILE
         -i -    --input=-        Read JWE from standard input

         -I FILE --detached=FILE  Read decoded ciphertext from FILE
         -I -    --detached=-     Read decoded ciphertext from standard input

         -o JSON --output=JSON    Parse JWE from JSON
         -o FILE --output=FILE    Read JWE from FILE
         -o -    --output=-       Read JWE from standard input
                                  Default: "-"

         -O JSON --detach=JSON    Parse JWE from JSON
         -O FILE --detach=FILE    Read JWE from FILE
         -O -    --detach=-       Read JWE from standard input

         -c      --compact        Output JWE using compact serialization

       Failed to import token from file.
       Error saving metadata to LUKS2 header in device /dev/vda4
       Unable to update metadata; operation cancelled
       Error adding new binding to /dev/vda4</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can adapt this <code>virt-install</code> command to install your VMs according to your needs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-install --name=edge-device \
--vcpus=2 \
--memory=1536 \
--cdrom=&lt;PATH TO RHEL OSTREE ISO&gt; \
--disk size=20 \
--os-variant=rhel9.1 \
--boot uefi \
--tpm backend.type=emulator,backend.version=2.0,model=tpm-crb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another options is <code>virt-manager</code>. Take a look at the animated GIF below if you want to review the whole VM creation process when using virt-manager.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/vm_create.gif" alt="Create VM GIF">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-first"><a class="anchor" href="#onboard-first"></a>Step 1 - Edge device&#8217;s first boot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your OSTree RHEL installation ISO is ready for FDO onboarding. In production (remember, with the FDO distributed in multiple servers) you would have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can use that ISO at the manufacturing site (remember that the manufacturing location probably is different than the final edge location) to <strong>preinstall</strong> your systems and then distribute them to their final locations (at the owner&#8217;s site).</p>
</li>
<li>
<p>You can directly distribute the ISO to preinstall the devices at the owner&#8217;s site.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first option is probably the better one, since you will need access to the Manufacturing server while performing the preinstallation and can skip that step at the owner&#8217;s site, where you might not have specialized people who, for example, know how to boot from ISO.</p>
</div>
<div class="paragraph">
<p>In this lab we could say that the manufacturing site and the final edge site are the same, so&#8230;&#8203;we do not need to worry about it. You just need to boot the VM that you created with the OSTree RHEL ISO. This is an example of the console output shown during the first boot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/onboarding-console.png" alt="Onboarding console">
</div>
</div>
<div class="paragraph">
<p>Once the device boots from that ISO, three main points are covered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include the required tools to “identify” the device such as the FDO client and a set of certificates and keys.</p>
</li>
<li>
<p>The Rendezvous server endpoint (URL) is included in the device</p>
</li>
<li>
<p>The Ownership Voucher is created.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During this phase, a pre-installed device is created with the certificates (that will authenticate the system) and with the FDO client ready to contact the Rendezvous and Owner servers in order to start the onboarding customization.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Remember that when you create the RHEL image the FDO client is included along with the certificates and keys that have been generated during the FDO manufacturing service preparation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Manufacturing server creates the owner voucher and store it in the  <code>owner_vouchers</code> directory. You can connect to the Manufacturing server (or All-in-One server) and double-check that the voucher is created:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_input-all-in-one-server"></a>input All-in-one server</p>
</li>
<li>
<p><a id="tabset1_input-dedicated-servers"></a>input Dedicated servers</p>
</li>
<li>
<p><a id="tabset1_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_input-all-in-one-server">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls /etc/fdo/aio/stores/owner_vouchers/</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_input-dedicated-servers">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls /etc/fdo/stores/owner_vouchers/</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ccc1b09c-1a0d-8c47-bf42-3a18901c00a8</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After the installation, the system will reboot directly from the hard disk and will try to start the boot-time automation to complete the system installation.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> If you are running in an ARM system, it could happen that the device does not reboot automatically and it enters into the <code>Emergency mode</code> instead. As far as I&#8217;ve seen in the logs, it happens because it fails to "start Switch Root" but if you reboot your machine the installed image should work, so the rest of the steps of this tutorial are completly valid.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The configured onboarding automation steps won&#8217;t happen unless you have the All-in-One FDO server, because before being able to jump into the actual onboarding, you need to distribute the Vouchers.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> If you installed the All-in-One server, you can jump into the <a href="#onboard-finalboot">Step 3 - Automatic onboarding</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In summary, after this step you have two different outputs: a preconfigured device and the Owner Voucher. Now you will have to physically send the device to the final destination (of course that&#8217;s in the real world, not in this lab) and, at the same time, copy the Owner Voucher as is explained in the next point.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-voucher"><a class="anchor" href="#onboard-voucher"></a>Step 2 - Distribute the Vouchers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using the All-in-One FDO server, the manufacturing server, Rendezvous server and the Owner onboarding server do share the same vouchers store (same directory) and hence the Manufacturing server does “report” the voucher automatically as soon as it creates it (remember that in case that you are using the all-in-one approach you can jump into the next step, <a href="#onboard-finalboot">Automatic onboarding</a>)</p>
</div>
<div class="paragraph">
<p>In the real world where you probably have the FDO services in dedicated servers that does not happen, so you need to copy the files to "register" the new device that you have created, otherwise the device will ask for its onboarding instructions but since it&#8217;s not registered, it will get nothing.</p>
</div>
<div class="paragraph">
<p>You need to distribute the Voucher that has been created in the Manufacturing server during the edge device first boot, to both the Rendezvous and the Owner server.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> There is a setting (<code>report_to_rendezvous_endpoint_enabled</code>) in the Owner server that automatically copies the Voucher from the Owner server to the Rendezvous, so you would only need to copy the Voucher to the Owner server, not to both. If you used the provided configuration files for the Owner server you will have this setting to <code>true</code>, so you could skip the copy to the Rendezvous server.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Jump into the Manufacturing server and copy the Voucher to the Rendezvous server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">scp /etc/fdo/stores/owner_vouchers/&lt;VOUCHER ID&gt; root@&lt;RENDEZVOUS SERVER IP&gt;:/etc/fdo/stores/rendezvous_registered/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, from the Manufacturing server, copy the file to the Owner server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">scp /etc/fdo/stores/owner_vouchers/&lt;VOUCHER ID&gt; root@&lt;OWNER SERVER IP&gt;:/etc/fdo/stores/owner_vouchers/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-finalboot"><a class="anchor" href="#onboard-finalboot"></a>Step 3 - Automatic onboarding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that everything is prepared, it&#8217;s time to reboot again the edge device.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Remember that with All-in-One you don&#8217;t have to reboot again, the device will be rebooted after the first boot and the onboarding process will start automatically.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>During this phase, the FDO client will identify itself into the Rendezvous server with the keys that were provided during the device preinstallation phase, create a secure channel to the Owner server and perform the automation configured in the service API service configuration file.</p>
</div>
<div class="paragraph">
<p>Before checking anything on the system you need to log in using the user that you configured in the RHEL OSTree image blueprint (<code>admin</code> if you used the defaults). If you configured your system&#8217;s SSH Public key it won&#8217;t ask for any password.</p>
</div>
<div class="paragraph">
<p>Once you are in the Edge Device, you can follow the FDO client logs until its completion (remember to break the command with <code>CTL-C</code>):</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> In the example below, you will need to scroll to the right in order see the whole output of the command.</p>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_input"></a>input</p>
</li>
<li>
<p><a id="tabset2_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -u fdo-client-linuxapp -f</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Dec 13 05:05:41 edge-3e92db36 subscription-manager[2233]: Added subscription for product 'Red Hat OpenStack Beta for IBM Power LE'
Dec 13 05:05:41 edge-3e92db36 subscription-manager[2233]: Added subscription for product 'Red Hat JBoss Core Services'
Dec 13 05:05:41 edge-3e92db36 subscription-manager[2233]: Added subscription for product 'Red Hat Gluster Storage Web Administration (for RHEL Server)'
Dec 13 05:05:41 edge-3e92db36 subscription-manager[2233]: Added subscription for product 'Red Hat S-JIS Support (for RHEL Server) - AUS'
Dec 13 05:06:22 edge-3e92db36 podman[3231]: 2022-12-13 05:06:22.523403789 -0500 EST m=+0.180416078 system refresh
Dec 13 05:06:44 edge-3e92db36 fdo-client-linuxapp[1138]:  2022-12-13T10:06:44.873Z INFO  fdo_client_linuxapp::serviceinfo &gt; Initiating disk re-encryption, disk-label: /dev/vda4, pin: tpm2, config: {}, reencrypt: true
Dec 13 05:06:45 edge-3e92db36 fdo-client-linuxapp[1138]:  2022-12-13T10:06:45.819Z INFO  fdo_client_linuxapp              &gt; Secure Device Onboarding DONE
Dec 13 05:06:45 edge-3e92db36 systemd[1]: fdo-client-linuxapp.service: Deactivated successfully.
Dec 13 05:06:45 edge-3e92db36 systemd[1]: Finished FDO client.
Dec 13 05:06:45 edge-3e92db36 systemd[1]: fdo-client-linuxapp.service: Consumed 51.257s CPU time</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The FDO client should be executed as the system starts, bu you can also re-launch it by restarting the <code>fdo-client-linuxapp</code> service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl restart fdo-client-linuxapp.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get logs that will depend on your configured onboarding automation and it will indicate that everything when OK with a <code>Secure Device Onboarding DONE</code> message as shown above.</p>
</div>
<div class="paragraph">
<p>If you just see <code>Starting FDO client&#8230;&#8203;</code> but nothing else happens, probably there is a configuration issue somewhere. Start by checking the Owner server logs and Serviceinfo_API configuration and listening ports.</p>
</div>
<div class="paragraph">
<p>If you see something like <code>"No usable device credential located"</code>, that could mean that the RHEL ISO image was created but the FDO Manufacturing server was not available during the image creation, so the required certificates and keys were not introduced in the image. If that&#8217;s the case, jump into the Image Builder and review the Manufacturing URL in the <code>blueprint-fdo</code> file. Check that its appears as <code><a href="http://&lt;manufacturing" class="bare">http://&lt;manufacturing</a> ip&gt;:&lt;manufacturing port&gt;</code> and also check that the manufacturing port (by default 8080) is listening in the Manufacturing server using <code>ss -ltn</code>. If the Manufacturing server is working and is specificated in the blueprint file, then check that the device disk configured in the blueprint is also correct. If you find anything wrong&#8230;&#8203; you will need to create a new ISO.</p>
</div>
<div class="paragraph">
<p>Disk encryption was one of the options that you could configured in the Serviceinfo_API service. If encryption/re-encryption was required, you could also check if that&#8217;s done now:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_input"></a>input</p>
</li>
<li>
<p><a id="tabset3_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">lsblk</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                          MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINTS
sr0                                            11:0    1 1024M  0 rom
vda                                           252:0    0   20G  0 disk
├─vda1                                        252:1    0    1M  0 part
├─vda2                                        252:2    0  127M  0 part  /boot/efi
├─vda3                                        252:3    0  384M  0 part  /boot
└─vda4                                        252:4    0 19.5G  0 part
  └─luks-0f4d6096-37cb-4eb8-88d6-abac5cd73db9 253:0    0 19.5G  0 crypt
    └─rootvg-rootlv                           253:1    0    9G  0 lvm   /var
                                                                        /usr
                                                                        /
                                                                        /sysroot</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this moment your onboarding is done!, you can start reviewing if the automation that you configured actually worked as you expected.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-checks"><a class="anchor" href="#onboard-checks"></a>Checking the edge device onboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you prepared your onboarding automation you will need to know by your own how to check if it worked or not depending on what you configured.</p>
</div>
<div class="paragraph">
<p>In case you used the provided onboarding automation example, in this section you can see how to check that everything went OK.</p>
</div>
<div class="paragraph">
<p>The example automation runs several scripts and copy multiple files, but mainly you can check:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>That the system has been renamed with a random hostname</p>
</li>
<li>
<p>That the system is subscribed to the <a href="https://console.redhat.com">Hybrid Cloud Console</a> and appears in Insights.</p>
</li>
<li>
<p>That you can run an OpenSCAP compliance report</p>
</li>
<li>
<p>That you have Cockpit and KVM installed</p>
</li>
<li>
<p>That a Greenboot script has been configured</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s start checking the Edge device hostname (your hostname will be different):</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_input"></a>input</p>
</li>
<li>
<p><a id="tabset4_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">hostname</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">edge-3e92db36</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now you can also Check Insight inventory in the <a href="https://console.redhat.com">Hybrid Cloud Console</a> and also review if a <code>TAG</code> with the name <code>edge-factory</code> has been configured (in my case you can see that the FDO servers and the Image Builder are there as well)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/insights-inventory.png" alt="Insights inventory">
</div>
</div>
<div class="paragraph">
<p>One remark, in order to subscribe any RHEL system, you need the user and password, and what is important about FDO is that we provided such secrets <strong>without including them on the ISO image</strong>, they are present just in a managed and secured environment (Owner server) and they have been downloaded from there using a secure channel.</p>
</div>
<div class="paragraph">
<p>In order to get the SCAP compliance report, your system needs to be part of a SCAP policy. You will need to first go to the Policy page and include the new edge system (if you don&#8217;t have any SCAP Policy pre-configured you need to create one):</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>IDEA FOR IMPROVING THE EXAMPLE:</strong> If you have time, you can create an Ansible playbook that adds the system automatically to one pre-created SCAP policy in the Hybrid Console as part of the onboarding process, so we remove this manual step.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/scap-policy.png" alt="Insights inventory">
</div>
</div>
<div class="paragraph">
<p>Once the system is added to a policy, you can wait until the SCAP client is executed&#8230;&#8203; but that could be up to 24 hours, so it&#8217;s better to force it by running this command on the Edge Device:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_input"></a>input</p>
</li>
<li>
<p><a id="tabset5_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo insights-client --compliance</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#System uses SSG version 0.1.63
#Running scan for xccdf_org.ssgproject.content_profile_cis... this may take a while
#Uploading Insights data.
#Successfully uploaded report for edge-3e92db36</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When the command finishes, you have access to the report in the Hybrid Console:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/compliant-report.png" alt="Compliant report">
</div>
</div>
<div class="paragraph">
<p>Another thing to be checked is if KVM and Cockpit (with VM management) was installed, so you have to visit <code><a href="https://&lt;EDGE" class="bare">https://&lt;EDGE</a> DEVICE IP&gt;:9090</code> and review the VM management</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> You are not supposed to run any VM. If you are using VMs as Edge Devices as we are doing in this lab, you need to enable nested virtualization to run VMs on top of VMs (and having enough resources in your Edge Device&#8230;&#8203; probably 2 vCPUs and 1.5GB of memory is not enough)</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kvm-edge.png" alt="KVM Edge">
</div>
</div>
<div class="paragraph">
<p>Lastly you can check if a Greenboot script has been created on the system. Greenboot is a cool feature on OSTree RHEL systems that is used to automatically rollback upgrades in case something fails, if this is new for you, <a href="https://www.redhat.com/en/blog/automating-rhel-edge-image-rollback-greenboot">you should learn more about it</a>.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_input"></a>input</p>
</li>
<li>
<p><a id="tabset6_output"></a>output</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_input">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat /etc/greenboot/check/required.d/01_check_demo_file.sh</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_output">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

#
# This test fails if /root/mustfail file exist
#

FILE=/root/mustfail
if [ -f "$FILE" ]; then
    echo "$FILE exists: Check FAILED!"
    exit 1
else
    echo "$FILE does not exist: Check PASSED!"
    exit 0
fi</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-change"><a class="anchor" href="#onboard-change"></a>Updating the onboard automation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You completed the onboarding, everything is OK, but what happens if you realize that you need to include additional customizations or change anything on the configured automations for the upcoming device onboardings?</p>
</div>
<div class="paragraph">
<p>We find three different "kind" of changes here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Modify the content of an existing file that is copied to the systems during the onboarding</p>
</li>
<li>
<p>Modify the commands or files copied during the onboarding</p>
</li>
<li>
<p>Modify the base image (Software included by default in the Edge Device)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Taking a look at the provided onboarding automation, an example for the first type of change could be modifying the Greenboot file. For example, we would like that the Greenboot script, instead of reviewing that a file exists in <code>/root/mustfail `(variable `FILE=/root/mustfail</code> in the <code>01_check_demo_file.sh</code> script), it checks a different path.</p>
</div>
<div class="paragraph">
<p>For this kind of change, you only have to directly modify the file in the Owner server (if you followed the lab steps you will find it in <code>/etc/fdo-configs/device0/etc/greenboot/check/required.d/01_check_demo_file.sh</code>) and the following devices that perform the FDO onboarding will get the new file. You don&#8217;t need to touch anything else, including the serviceinfo-api-server.yml because you are not modifying the name or the PATH to the Greenboot file, only its contents.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> Remember that the already onboarded devices won&#8217;t get this change. FDO is managing the onboarding only, any day-2 operation must be covered but additional tooling (ie. Ansible)</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you need to modify the commands or files copied during the onboarding (for example, you want to copy additional file into your systems while onboarding them) you will need to change the <code>/etc/fdo/serviceinfo-api-server.yml</code> file in the Owner server including the required new lines pointing to the new file (and the file should be created in the path configured) and lastly, and very important, you need to <strong>restart the Serviceinfo_API server</strong> in order to make that change effective.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>NOTE:</strong> The service is <code>fdo-aio.service</code> if you are using All-in-One FDO server or <code>fdo-serviceinfo-api-server.service</code> in dedicated Owner sever</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The last kind of change is different. If you want to change the base OSTree RHEL image by adding (or removing) RPM packages, you will need to use the Image Builder to create a new Blueprint to generate an updated OSTree repo/image and a new ISO. The steps are similar&#8230;&#8203; but not equal to the ones that you performed during the lab, since you want to update an existing OSTree repo, not create a new one.</p>
</div>
<div class="paragraph">
<p>OSTree RHEL image management is out of the scope of this lab, so you can get this task as an additional homework, but if you want some hints, you can check the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#creating-a-rhel-for-edge-image-with-a-parent-commit-using-image-builder-command-line-interface_composing-a-rhel-for-edge-image-using-image-builder-command-line">official documentation</a> or <a href="https://github.com/luisarizmendi/rhel-edge-quickstart/blob/master/1-create-image.sh#L100">this script</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="onboard-summary"><a class="anchor" href="#onboard-summary"></a>Edge device onboarding Lab summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you have:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Created a VM that will act as edge device</p>
</li>
<li>
<p>Used the FDO enabled RHEL OSTree ISO image to install the edge device</p>
</li>
<li>
<p>Reviewed the onboarding process and completion</p>
</li>
<li>
<p>Included changes into the device onboarding automation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>CONGRATULATIONS!, you finished the last LAB, and I hope that you enjoyed it.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-rfe-lab.html" class="query-params-link">2.b RHEL OSTree image - Lab</a></span>
  <span class="next"><a href="99-summary.html" class="query-params-link">Summary</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
